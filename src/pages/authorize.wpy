<style lang="less">
.authorize_contianer {
  height: 100%;
  padding-top: 100rpx;
  .authorize_icon {
    width: 308rpx;
    height: 111rpx;
    text-align: center;
    display: block;
    margin: 0 auto;
    padding-bottom: 10rpx;
  }
}
.title_name_tx {
  font-family: PingFangSC-Semibold;
  font-size: 38rpx;
  color: #ADC7C7;
  text-align: center;
  line-height: 43rpx;
  margin-top: 30rpx;
  margin-bottom: 50rpx;
}
.login_view_column {
  background: #FFFFFF;
  border-radius: 26rpx;
  margin-left: 50rpx;
  margin-right: 50rpx;
  margin-top: 20rpx;
  padding-left: 70rpx;
  padding-right: 70rpx;
  display: flex;
  flex-direction: column;
  .login_view_row {
    display: flex;
    flex-direction: row;
    align-items: center;
    border-bottom: 1px solid #efefef;
    padding-bottom: 20rpx;
    padding-top: 70rpx;
    .login_image {
      width: 30rpx;
      height: 35rpx;
    }
    .login_input {
      width: 100%;
      font-family: PingFangSC-Regular;
      font-size: 30rpx;
      color: #3B403D;
      margin-left: 14rpx;
    }
  }
  .btn_authorize {
    width: 100%;
    background: #007474;
    box-shadow: 0 6rpx 20rpx 0 rgba(0,116,116,0.20);
    border-radius: 12rpx;
    font-family: PingFangSC-Medium;
    font-size: 34rpx;
    color: #FFFFFF;
    text-align: center;
    margin-top: 86rpx;
    margin-bottom: 56rpx;
  }
}

</style>
<template>
  <view class="authorize_contianer">
    <image class="authorize_icon" src="../images/logo_sinsim.png"></image>
    <view class="title_name_tx">-员工端-</view>
    <view class="login_view_column">
      <view class="login_view_row">
        <image class="login_image" src="../images/icon_login_account.png"></image>
        <input class="login_input" type="text" focus="true" @input="bindAccountInput" placeholder="输入你的账号"/>
      </view>
      <view class="login_view_row">
        <image class="login_image" src="../images/icon_login_password.png"></image>
        <input class="login_input" type="text" password="true" @input="bindPasswordInput" placeholder="输入你的密码"/>
      </view>
      <button class="btn_authorize" lang="zh_CN" @tap="bindLogin">授权登录</button>
    </view>
  </view>
</template>
<script>
  /* eslint-disable no-undef,eqeqeq,indent */

  import wepy from 'wepy'
  import api from '@/api/api'
  import tip from '@/utils/tip'
  import {
    AUTHORIZATION,
    AUTHORIZATION_PATH,
    ACCOUNT,
    USER_ID
  } from '@/utils/constant'
  export default class Authorize extends wepy.page {
    config = {
      navigationBarTitleText: '授权登录'
    }
    data = {
      account: 'zhaopu',
      password: 'sinsim',
      jcCode: ''
    }
    async onLoad() {
      let fs = wx.getFileSystemManager()
      let fsStat = fs.statSync(AUTHORIZATION_PATH, false)
      console.log(fsStat)
      if (fsStat.stats.isDirectory()) {
        let res = await wepy.login()
        console.log(res)
        if (res.code) {
          this.jcCode = res.code
          console.log(this.jcCode)
          let auth = fs.readFileSync(AUTHORIZATION_PATH, 'utf8')
          console.log('auth: ', auth)
          wx.setStorageSync(AUTHORIZATION, auth)
          let loginJson = await api.autoLogin({
            query: {
              jsCode: this.jcCode
            }
          })
          console.log(loginJson)
          if (loginJson.data.code == 400) {
            tip.confirm(rlt.data.message + '+onLoad')
          } else if (loginJson.data.code == 200) {
            let userJson = JSON.parse(loginJson.data.data)
            wx.setStorageSync(ACCOUNT, userJson.account)
            wx.setStorageSync(USER_ID, userJson.id)
            wepy.switchTab({
                url: '/pages/repair'
            })
          }
        } else {
          tip.confirm('登陆失败')
        }
      }
    }
    methods = {
      bindAccountInput(e) {
        console.log(e.detail.value)
        this.account = e.detail.value
      },
      bindPasswordInput(e) {
        console.log(e.detail.value)
        this.password = e.detail.value
      },
      async bindLogin() {
        let res = await wepy.login()
        console.log(res)
        if (res.code) {
          this.jcCode = res.code
          console.log(this.jcCode)
          let rlt = await api.wxJsCode2Session({
            query: {
              account: this.account,
              password: this.password,
              jsCode: this.jcCode
            }
          })
          console.log('get session resoult: ', rlt)
          // wx.setStorageSync(AUTHORIZATION, 'Bearer eyJhbGciOiJIUzUxMiJ9.eyJzdWIiOiJ7XCJhY2NvdW50XCI6XCJ6aGFvcHVcIixcImFjY291bnROb25FeHBpcmVkXCI6dHJ1ZSxcImFjY291bnROb25Mb2NrZWRcIjp0cnVlLFwiYWRkcmVzc1wiOlwiXCIsXCJhZ2VudFwiOjAsXCJhdXRob3JpdGllc1wiOltdLFwiY3JlYXRlVGltZVwiOjE1MzIxMzQ0MjkwMDAsXCJjcmVkZW50aWFsc05vbkV4cGlyZWRcIjp0cnVlLFwiY3VzdG9tZXJDb21wYW55XCI6XCIxXCIsXCJlbmFibGVkXCI6dHJ1ZSxcImlkXCI6OCxcIm5hbWVcIjpcInpoYW9wdVwiLFwicGFzc3dvcmRcIjpcInNpbnNpbVwiLFwicGhvbmVcIjpcIjEzMTg4ODg4ODg4XCIsXCJyb2xlSWRcIjozLFwidXNlcm5hbWVcIjpcInpoYW9wdVwiLFwidmFsaWRcIjpcIjFcIn0iLCJleHAiOjE1NDA2OTgxNDZ9.70rPlMhSCZmozswaWrX1aut64Ga2aGSLk6ZchGy6DODEImcD_eSye_WVcgL0mJby9Rk2vwcVcg5HbdX_QBuX_g')
          // wx.setStorageSync(ACCOUNT, this.account)
          // wx.setStorageSync(USER_ID, 8)
          if (rlt.data.code == 400) {
            tip.confirm(rlt.data.message)
          } else if (rlt.data.code == 200) {
            let loginJson = await api.login({
              query: {
                account: this.account,
                password: this.password
              }
            })
            console.log('登入返回：', loginJson)
            if (loginJson.statusCode == 200) {
              wx.setStorageSync(AUTHORIZATION, loginJson.header.Authorization)
              wx.setStorageSync(ACCOUNT, loginJson.data.account)
              wx.setStorageSync(USER_ID, loginJson.data.id)
              let fs = wx.getFileSystemManager()
              fs.writeFileSync(AUTHORIZATION_PATH, rlt.header.Authorization, 'utf8')
              wepy.switchTab({
                url: '/pages/repair'
              })
            } else {
              tip.confirm('网络错误，登陆失败')
            }
          } else {
              tip.confirm('网络错误，登陆失败')
          }
        } else {
          tip.confirm('登陆失败')
        }
      }
    }
    events = {
    }
}

</script>
